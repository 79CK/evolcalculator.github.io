<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>恋与制作人计算器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="evol calculator">
    <meta name="keywords" content="calculator">
    <meta name="author" content="Darina">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-cal.css" />
    <link rel="stylesheet" type="text/css" href="css/cal_style.css" />
    <style type="text/css">
    .mycard {
        margin-bottom: 20px;
        padding: 10px;
        width: 100%;
    }

    .label-above {
        display: inline-block;
        width: 100%;
        text-align: left;
        font-size: small;
    }

    .table thead tr th,
    .table tbody tr th,
    .table tbody tr td {
        text-align: center;
        vertical-align: middle;
    }

    .form-group {
        padding-right: 15px;
        padding-bottom: 15px;
    }

    .form-group .btn.form-control {
        margin-top: 25px;
    }

    .link {
        text-decoration: underline;
    }

    .load1 {
        height: 50px;
    }

    h4 span, .form-group span {
        display: inline-block;
        padding: 0 10px;
    }

    .form-group div {
        padding-right: 0;
    }

    .modal-main {
        padding-top: 10px;
    }

    .modal-main .label-above {
        margin-top: 10px;
    }

    .help-block {
        font-size: small;
        text-align: left;
    }

    .help-block a {
        margin: 0 5px;
    }

    .modal-main .help-block {
        margin-top: 10px;
    }

    .modal-main .radio {
        text-align: left;
        font-size: small;
    }

    .modal-main .radio label {
        padding-right: 10px;
    }

    .modal-body textarea {
        height: 150px;
    }

    .modal-body .alert {
        padding: 5px;
        font-size: small;
        margin-bottom: 0;
    }
    
    .pd15 {
        padding: 15px;
    }

    .typeahead {
        max-width: 300px;
    }

    .cell {
        max-width: 100px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .cell.cell-all {
        white-space: normal;
        word-wrap: break-word;
    }
    </style>
    <script type='text/javascript' charset="utf-8" src='js/jquery.js'></script>
    <script type='text/javascript' charset="utf-8" src='js/storage.js'></script>
    <script type='text/javascript' charset="utf-8" src='js/bootstrap.js'></script>
    <script type='text/javascript' charset="utf-8" src='js/bootstrap3-typeahead.min.js'></script>
    <script type='text/javascript' charset="utf-8" src='js/vue.min.js'></script>
</head>

<body>
    <div id="app">
        <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-menu">
                        <span class="sr-only">切换导航</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a href="javascript:;" class="navbar-brand nav-title"><img src="img/logo-s.png" alt="header"/></a>
                </div>
                <div class="collapse navbar-collapse" id="navbar-menu">
                    <ul class="nav navbar-nav navbar-right">
                        <li :class="{active: nav == 'level'}"><a href="javascript:;" @click="nav = 'level'">关卡计算</a></li>
                        <li :class="{active: nav == 'card'}"><a href="javascript:;" @click="nav = 'card'">我的羁绊</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="container">
            <div class="item_body">
                <div class="mycard">
                    <h3>恋与制作人计算器v2.0</h3>
                    <p>
                        <h4>数据来源</h4> 权重数据来源 <a href="https://weibo.com/unnamedgroup" target="_blank">@恋与制作人未命名攻略组</a>
                        <br> 计算器制作 @达尔娜 @清澄 @鱼骨头
                    </p>
                </div>
                <div class="mycard">
                    <div v-if="!empty(company)">
                        <h4>
                            <span>{{user.name}}</span>
                            <a href="javascript:;" @click="show_login('user_login')">切换</a>
                            <a href="javascript:;" @click="logout()">注销</a>
                        </h4>
                        <div class="form-group">
                            <span>羁绊数量：{{list.length}}</span>
                            <a href="javascript:;" @click="nav = 'card'" v-show="nav != 'card'">查看</a>
                            <a href="javascript:;" @click="nav = 'level'" v-show="nav != 'level'">关卡计算</a>
                        </div>
                        <h4>公司属性</h4>
                        <div class="form-group clearfix">
                            <div class="col-xs-3 col-md-2">
                                <label class="label-above">决策</label>
                                <input type="number" class="form-control" v-model="company.decisiveness">
                            </div>
                            <div class="col-xs-3 col-md-2">
                                <label class="label-above">创造</label>
                                <input type="number" class="form-control" v-model="company.creativity">
                            </div>
                            <div class="col-xs-3 col-md-2">
                                <label class="label-above">亲和</label>
                                <input type="number" class="form-control" v-model="company.kindness">
                            </div>
                            <div class="col-xs-3 col-md-2">
                                <label class="label-above">行动</label>
                                <input type="number" class="form-control" v-model="company.activity">
                            </div>
                            <div class="col-xs-3 col-sm-2 col-lg-1">
                                <button id="update_company" type="button" data-loading-text="保存中..." class="btn btn-primary form-control" autocomplete="off" @click="update_company()">保存</button>
                            </div>
                        </div>
                    </div>
                    <div v-else>
                        <h4>我的公司</h4>
                        <p>初次使用请先<a href="javascript:;" @click="show_login('create_user')">创建公司</a>，或<a href="javascript:;" @click="show_login('user_login')">进入公司</a></p>
                        <p>公司用于在线保存个人数据</p>
                    </div>
                </div>
                <div class="mycard" v-show="nav == 'card'">
                    <div v-show="!empty(company)">
                        <h4>添加羁绊</h4>
                        <div class="pd15">
                            <label class="label-above">输入关键字，添加或修改羁绊</label>
                            <input type="text" class="typeahead form-control" data-provide="typeahead" autocomplete="off">
                            <p class="help-block">添加时先输入等级，自动推算属性值</p>
                        </div>
                        <div class="form-group">
                            <a href="javascript:;" class="btn btn-default" @click="show_batch('export_data')">导出</a>
                            <a href="javascript:;" class="btn btn-primary" @click="show_batch('import_data')">导入</a>
                        </div>
                        <div class="alert alert-warning" role="alert" v-show="!empty(batch.fail)">
                            以下导入失败，请检查名称是否正确：<br>
                            <template v-for="item in batch.fail">
                                <small style="margin: 0 5px;">{{item.name}}</small>
                            </template>
                            <button type="button" class="close" aria-label="Close" @click="batch.fail = []"><span aria-hidden="true">&times;</span></button>
                        </div>
                    </div>

                    <h4>我的羁绊</h4>

                    <div class="form-group" v-show="empty(company)">
                        <a href="javascript:;" class="link" @click="show_login('create_user')">创建</a>或<a href="javascript:;" class="link" @click="show_login('user_login')">进入</a>公司后获取羁绊数据
                    </div>

                    <p v-show="list.length > 1"><a href="javascript:;" @click="remove_all()">删除全部</a></p>

                    <div class="form-group clearfix">
                        <div class="col-xs-4 col-md-3 col-lg-2">
                            <label class="label-above">人物</label>
                            <select class="form-control" v-model="card_filter.category">
                                <option value="0">全部</option>
                                <option value="1">李泽言</option>
                                <option value="2">许墨</option>
                                <option value="3">周棋洛</option>
                                <option value="4">白起</option>
                                <option value="5">其他</option>
                            </select>
                        </div>
                        <div class="col-xs-4 col-md-3 col-lg-2">
                            <label class="label-above">稀有度</label>
                            <select class="form-control" v-model="card_filter.type">
                                <option value="0">全部</option>
                                <option value="5">SSR</option>
                                <option value="4">SR</option>
                                <option value="3">R</option>
                                <option value="2">NH</option>
                                <option value="1">N</option>
                            </select>
                        </div>
                        <div class="col-xs-4 col-md-3 col-lg-2">
                            <label class="label-above">筛选</label>
                            <input type="text" class="form-control" v-model="card_filter.name">
                        </div>
                    </div>

                    <table class="table table-bordered table-hover" v-show="!empty(list)">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>等级</th>
                                <th class="hidden-xs">决策</th>
                                <th class="hidden-xs">创造</th>
                                <th class="hidden-xs">亲和</th>
                                <th class="hidden-xs">行动</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="item in list" v-show="use_filter(card_filter, item)">
                                <td>{{item.name}} <sub>{{get_type_tag(item.type)}}</sub></td>
                                <td>lv.{{item.level}} {{get_star_print(item.star)}} {{get_evolved_tag(item.evolved)}}</td>
                                <td class="hidden-xs">{{item.decisiveness}}</td>
                                <td class="hidden-xs">{{item.creativity}}</td>
                                <td class="hidden-xs">{{item.kindness}}</td>
                                <td class="hidden-xs">{{item.activity}}</td>
                                <td>
                                    <a href="javascript:;" @click="show_card(item.card_id)">修改</a>
                                    <a href="javascript:;" @click="remove_card(item.card_id)">删除</a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mycard" v-show="nav == 'level'">
                    <h4>关卡计算</h4>
                    <div class="form-group" v-show="list.length < 3">
                        <a href="javascript:;" @click="nav = 'card'">添加</a>三张以上羁绊开启
                    </div>
                    <div class="form-group clearfix" v-if="!empty(select)">
                        <div class="col-xs-4 col-sm-3 col-md-2">
                            <label class="label-above">类别</label>
                            <select class="form-control" v-model="category">
                                <option :value="key" v-for="(item, key) in select">{{get_category_tag(key)}}</option>
                            </select>
                        </div>
                        <div class="col-xs-4 col-sm-3 col-md-2">
                            <label class="label-above">章节</label>
                            <select class="form-control" v-model="chapter">
                                <option :value="key" v-for="(item, key) in select[category]">第{{key}}章</option>
                            </select>
                        </div>
                        <div class="col-xs-4 col-sm-3 col-md-2">
                            <label class="label-above">关卡</label>
                            <select class="form-control" v-model="level">
                                <option value="0">全部</option>
                                <option :value="key" v-for="(item, key) in select[category][chapter]">{{chapter}}-{{key}}</option>
                            </select>
                        </div>
                        <div class="col-xs-4 col-sm-2 col-md-1" v-show="list.length >= 3">
                            <button id="get_levels" type="button" data-loading-text="加载中..." class="btn btn-primary form-control" autocomplete="off" @click="get_levels()">计算</button>
                        </div>
                    </div>
                    <table class="table table-bordered table-hover table-condensed" v-show="!empty(levels.list)">
                        <thead>
                            <tr>
                                <th>关卡</th>
                                <th class="hidden-xs hidden-sm">掉落</th>
                                <th class="hidden-xs">实力需求</th>
                                <th class="hidden-xs">特殊要求</th>
                                <th class="hidden-xs">推荐</th>
                                <th>高分羁绊</th>
                                <th>得分</th>
                                <th>星级</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template v-for="item in levels.list">
                                <tr v-for="i in [1, 2, 3]">
                                    <td rowspan="3" v-if="i == 1"><a href="javascript:;" class="link" @click="get_level(item.id)">{{item.chapter}}-{{item.level}}</a></td>
                                    <td rowspan="3" class="hidden-xs hidden-sm" v-if="i == 1">{{item.drops}}</td>
                                    <td rowspan="3" class="hidden-xs" v-if="i == 1">{{get_card_demand(item)}}</td>
                                    <td class="hidden-xs">{{item['request'+i]}}</td>
                                    <td class="hidden-xs cell" :class="{'cell-all': levels.overflow}" @click="levels.overflow = !levels.overflow">{{item['recommend'+i]}}</td>
                                    <td>{{item.combine[i-1]}}</td>
                                    <td rowspan="3" v-if="i == 1">{{item.score}}</td>
                                    <td rowspan="3" v-if="i == 1">{{get_rank_tag(item, item.score)}}</td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div v-show="!empty(levels.level)">
                        <table class="table table-bordered table-hover table-condensed">
                            <thead>
                                <tr>
                                    <th>关卡掉落</th>
                                    <th>实力需求</th>
                                    <th>特殊要求</th>
                                    <th>推荐</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(i, idx) in levels.level.loop">
                                    <td :rowspan="levels.level.count" v-if="idx == 0">{{levels.level.drops}}</td>
                                    <td :rowspan="levels.level.count" v-if="idx == 0">{{get_card_demand(levels.level)}}</td>
                                    <td>{{levels.level['request'+i]}}</td>
                                    <td class="cell" :class="{'cell-all': levels.overflow}" @click="levels.overflow = !levels.overflow">{{levels.level['recommend'+i]}}</td>
                                </tr>

                                <tr v-show="levels.level.pass_score > 0">
                                    <th>一星</th>
                                    <th>二星</th>
                                    <th>三星</th>
                                    <th>评级</th>
                                </tr>
                                <tr v-show="levels.level.pass_score > 0">
                                    <td>{{levels.level.pass_score}}</td>
                                    <td>{{levels.level.half_score}}</td>
                                    <td>{{levels.level.full_score}}</td>
                                    <td>{{get_rank_tag(levels.level, get_total_score())}}</td>
                                </tr>
                            </tbody>
                        </table>

                        <table class="table table-bordered table-hover table-condensed">
                            <tbody>
                                <tr>
                                    <th>公司得分</th>
                                    <td></td>
                                    <td>{{get_company_score()}}</td>
                                </tr>
                                <tr>
                                    <th>专家得分</th>
                                    <td></td>
                                    <td>{{get_special_score()}}</td>
                                </tr>
                                <tr v-for="(item, idx) in levels.combine">
                                    <th rowspan="3" v-if="idx == 0">羁绊得分</th>
                                    <td>{{item.name}} <sub>{{get_type_tag(item.type)}}</sub></td>
                                    <td>{{item.score}}</td>
                                </tr>
                                <tr>
                                    <th>总分</th>
                                    <td></td>
                                    <td>{{get_total_score()}}</td>
                                </tr>
                            </tbody>
                        </table>

                        <p class="help-block">注：过关分数存在误差仅供参考，压线过关需谨慎</p>
                    </div>

                    <h4>过关分析</h4>
                    <table class="table table-bordered table-hover" v-show="!empty(levels.cards)">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>等级</th>
                                <th class="hidden-xs">决策</th>
                                <th class="hidden-xs">创造</th>
                                <th class="hidden-xs">亲和</th>
                                <th class="hidden-xs">行动</th>
                                <th>得分</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="item in levels.cards">
                                <td>{{item.name}} <sub>{{get_type_tag(item.type)}}</sub></td>
                                <td>lv.{{item.level}} {{get_star_print(item.star)}} {{get_evolved_tag(item.evolved)}}</td>
                                <td class="hidden-xs">{{item.decisiveness}}</td>
                                <td class="hidden-xs">{{item.creativity}}</td>
                                <td class="hidden-xs">{{item.kindness}}</td>
                                <td class="hidden-xs">{{item.activity}}</td>
                                <td>{{item.score}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal fade" tabindex="-1" role="dialog" id="company">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-body">
                            <ul class="nav nav-tabs">
                                <li role="presentation" :class="{active: login.option == 'create_user'}"><a href="javascript:;" @click="login.option = 'create_user'">创建公司</a></li>
                                <li role="presentation" :class="{active: login.option == 'user_login'}"><a href="javascript:;" @click="login.option = 'user_login'">进入公司</a></li>
                            </ul>
                            <div class="modal-main clearfix">
                                <div class="col-xs-12 col-sm-6">
                                    <label class="label-above">公司名称</label>
                                    <input type="text" class="form-control" v-model="login.name">
                                </div>
                                <div class="col-xs-12 col-sm-6">
                                    <label class="label-above">密码保护</label>
                                    <input type="text" class="form-control" v-model="login.code">
                                </div>
                                <p class="col-xs-12 help-block">公司名称不能重复，密码保护可为空，设置密码可防止数据被他人修改</p>
                                <p class="col-xs-12 help-block" v-show="!empty(login.history) && login.option == 'user_login'">
                                    历史记录：
                                    <a href="javascript:;" v-for="(item, key) in login.history" @click="login.name=key;login.code=item;">{{key}}</a>
                                </p>
                            </div>
                            <div class="alert alert-warning" role="alert" v-show="login.warning">
                                {{login.warning}}
                                <button type="button" class="close" aria-label="Close" @click="login.warning = ''"><span aria-hidden="true">&times;</span></button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                            <button id="user_login" type="button" class="btn btn-primary" data-loading-text="确认中..." autocomplete="off" @click="user_login()">确认</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" tabindex="-1" role="dialog" id="card">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title">{{card_select.name}}</h4>
                        </div>
                        <div class="modal-body">
                            <div class="form-group clearfix">
                                <div class="col-xs-4 col-md-3 col-lg-2">
                                    <label class="label-above">进化</label>
                                    <select class="form-control" v-model="card_select.evolved">
                                        <option value="0">未进化</option>
                                        <option value="1">进化</option>
                                    </select>
                                </div>
                                <div class="col-xs-4 col-md-3 col-lg-2">
                                    <label class="label-above">星级</label>
                                    <input type="number" class="form-control" v-model="card_select.star">
                                </div>
                                <div class="col-xs-4 col-md-3 col-lg-2">
                                    <label class="label-above">等级</label>
                                    <input type="number" class="form-control" v-model="card_select.level">
                                </div>
                            </div>
                            <div class="form-group clearfix">
                                <div class="col-xs-3 col-md-2">
                                    <label class="label-above">决策</label>
                                    <input type="number" class="form-control" v-model="card_select.decisiveness">
                                </div>
                                <div class="col-xs-3 col-md-2">
                                    <label class="label-above">创造</label>
                                    <input type="number" class="form-control" v-model="card_select.creativity">
                                </div>
                                <div class="col-xs-3 col-md-2">
                                    <label class="label-above">亲和</label>
                                    <input type="number" class="form-control" v-model="card_select.kindness">
                                </div>
                                <div class="col-xs-3 col-md-2">
                                    <label class="label-above">行动</label>
                                    <input type="number" class="form-control" v-model="card_select.activity">
                                </div>
                            </div>
                            <p class="help-block">数据为自动推算，可能存在误差，如有需要请对照修改</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                            <button type="button" id="save_card" class="btn btn-primary" data-loading-text="保存中..." @click="save_card()">保存</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" tabindex="-1" role="dialog" id="batch">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-body">
                            <ul class="nav nav-tabs">
                                <li role="presentation" :class="{active: batch.option == 'import_data'}"><a href="javascript:;" @click="batch.option = 'import_data'">批量导入</a></li>
                                <li role="presentation" :class="{active: batch.option == 'export_data'}"><a href="javascript:;" @click="batch.option = 'export_data'">批量导出</a></li>
                            </ul>
                            <div class="modal-main">
                                <div class="radio">
                                    <label>
                                        <input type="radio" v-model="batch.source" value="calculator">
                                        计算器
                                    </label>
                                    <label>
                                        <input type="radio" v-model="batch.source" value="excel">
                                        Excel
                                    </label>
                                </div>
                                <textarea class="form-control" v-model="batch.data" v-show="batch.option == 'import_data'"></textarea>
                                <textarea class="form-control" v-model="batch.export" v-show="batch.option == 'export_data'"></textarea>
                                <p class="help-block" v-show="batch.option == 'import_data' && batch.source == 'calculator'">贴入计算器导出的JSON数据</p>
                                <p class="help-block" v-show="batch.option == 'import_data' && batch.source == 'excel'">贴入从表格复制的数据，第一列为羁绊名，后四列为羁绊属性</p>
                                <p class="help-block" v-show="batch.option == 'export_data'">数据在线保存，如有需要可以导出对应格式</p>
                            </div>
                        </div>
                        <div class="modal-footer" v-show="batch.option == 'import_data'">
                            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                            <button type="button" id="import_data" class="btn btn-primary" data-loading-text="导入中..." @click="import_data()">导入</button>
                        </div>
                        <div class="modal-footer" v-show="batch.option == 'export_data'">
                            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                            <button type="button" class="btn btn-primary" @click="export_data()">导出</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
    var vm = new Vue({
        el: "#app",
        data: {
            base_url: 'http://app.coderprepares.com/evol/calculator/',
            prop: ['decisiveness', 'creativity', 'kindness', 'activity'],
            dom_init: false, // 初始化dom元素
            nav: 'level', // 导航
            select: {}, // 关卡级联选择
            category: 1, // 类别
            chapter: 1, // 章节
            level: 0, // 关卡
            cards: {}, // 全羁绊信息
            card_list: [], // 全羁绊名称
            company: {}, //我的公司
            list: [], // 我的羁绊
            my_cards: [], //我的羁绊ID
            login: { // 登录信息
                name: '',
                code: '',
                warning: '',
                history: {},
                option: 'create_user'
            },
            user: { // 用户信息
                name: $.LS.get('name') || '',
                code: $.LS.get('code') || ''
            },
            card_select: { // 羁绊选择信息
                name: '',
                card_id: 0,
                evolved: 0,
                star: 1,
                level: 1,
                decisiveness: 0,
                creativity: 0,
                kindness: 0,
                activity: 0
            },
            //羁绊筛选
            card_filter: {
                category: 0,
                type: 0,
                name: ''
            },
            //批量导入
            batch: {
                option: 'import_data',
                source: 'calculator',
                data: '',
                export: '',
                fail: []
            },
            levels: {
                level: {},
                list: [],
                overflow: false,
                multiple: 2,
                cards: [],
                combine: []
            }
        },
        watch: {
            //关卡级联选择
            category: function(newVal, oldVal) {
                var category = parseInt(newVal, 10);
                if (!this.select[category][this.chapter]) {
                    this.chapter = 1;
                }
            },
            chapter: function(newVal, oldVal) {
                var chapter = parseInt(newVal, 10);
                if (!this.select[this.category][chapter][this.level]) {
                    this.level = 0;
                }
            },
            //羁绊选择
            'card_select.name': function(newVal, oldVal){
                var name = newVal;
                for(id in this.cards){
                    if(name == this.cards[id].name){
                        this.card_select.card_id = id;
                        break;
                    }
                }
            },
            'card_select.card_id': function(newVal, oldVal){
                var card_id = parseInt(newVal, 10);
                if(this.my_cards.indexOf(card_id) >= 0){
                    for(var i = 0; i < this.list.length; i++){
                        if(card_id == this.list[i].card_id){
                            this.card_select.name = this.list[i].name;
                            this.card_select.evolved = this.list[i].evolved;
                            this.card_select.star = this.list[i].star;
                            this.card_select.level = this.list[i].level;
                            break;
                        }
                    }
                }
                this.update_card_select();
            },
            'card_select.evolved': function(newVal, oldVal){
                this.update_card_select();
            },
            'card_select.star': function(newVal, oldVal){
                this.update_card_select();
            },
            'card_select.level': function(newVal, oldVal){
                this.update_card_select();
            }
        },
        methods: {
            //总分
            get_total_score: function(){
                var score = 0;
                score += this.get_company_score();
                score += this.get_special_score();

                for(var i = 0; i < this.levels.combine.length; i++){
                    score += this.levels.combine[i].score;
                }

                return score;
            },
            //公司得分
            get_company_score: function(){
                var prop = this.prop;
                var score = 0;

                for(var i = 0; i < prop.length; i++){
                    score += this.levels.level[prop[i]] * this.company[prop[i]] * this.levels.level['company'];
                }

                return Math.round(score);
            },
            //专家得分
            get_special_score: function(){
                var prop = this.prop;
                var score = 0;

                for(var i = 0; i < prop.length; i++){
                    score += this.levels.level[prop[i]] * this.company[prop[i]] * this.levels.level['special'] * this.levels.multiple;
                }

                return Math.round(score);
            },
            //获取实力需求
            get_card_demand: function(item){
                var prop = this.prop;
                var arr = [];
                for(var i = 0; i < prop.length; i++){
                    arr.push({
                        tag: prop[i],
                        weight: item[prop[i]]
                    });
                }
                arr.sort(function(a, b){
                    return b.weight - a.weight;
                });

                return this.get_prop_tag(arr[0].tag) + ' ' + this.get_prop_tag(arr[1].tag);
            },
            //属性标签
            get_prop_tag: function(attr){
                var ret = '';
                switch(attr){
                    case 'decisiveness':
                        ret = '决策';
                        break;
                    case 'creativity':
                        ret = '创造';
                        break;
                    case 'kindness':
                        ret = '亲和';
                        break;
                    case 'activity':
                        ret = '行动';
                        break;
                }
                return ret;
            },
            //关卡计算
            get_levels: function(){
                var self = this;
                self.levels.overflow = false;

                if(self.level != 0){
                    $level_id = self.select[self.category][self.chapter][self.level];
                    return self.get_level($level_id);
                }

                $('#get_levels').button('loading');
                $.ajax({
                    url: self.base_url + 'levels',
                    type: 'post',
                    data: {
                        category: self.category,
                        chapter: self.chapter
                    },
                    success: function(res) {
                        if (res.status == 1){
                            var list = res.list;

                            for(var i = 0; i < list.length; i++){
                                var item = list[i];
                                var my_cards = [];
                                for(var j = 0; j < self.list.length; j++){
                                    var score = 0;
                                    var card = self.list[j];
                                    var prop = self.prop;

                                    for(var k = 0; k < prop.length; k++){
                                        score += card[prop[k]] * item[prop[k]];
                                    }

                                    card.score = score;
                                    my_cards.push(card);
                                }
                                my_cards.sort(function(a,b){
                                    return b.score - a.score;
                                });

                                //羁绊得分
                                item.combine = [];
                                var total = 0;
                                for(var j = 0; j < 3; j++){
                                    item.combine.push(my_cards[j].name);
                                    total += my_cards[j].score;
                                }

                                var prop = self.prop;
                                for(var k = 0; k < prop.length; k++){
                                    //公司得分
                                    total += self.company[prop[k]] * item[prop[k]] * item['company'];
                                    //专家得分
                                    total += self.company[prop[k]] * item[prop[k]] * item['special'] * self.levels.multiple;
                                }
                                
                                item.score = Math.round(total);
                                item.half_score = Math.round((item.pass_score + item.full_score) / 2);
                                list[i] = item;
                            }

                            self.levels.list = list;
                        } else if (res.info) {
                            show_msg(res.info);
                        }
                    },
                    error: function(res) {
                        self.show_msg('请求失败');
                    },
                    complete: function() {
                        $('#get_levels').button('reset');
                    }
                });
            },
            //单关计算
            get_level: function(id){
                var self = this;
                self.levels.list = [];

                $('#get_levels').button('loading');
                $.ajax({
                    url: self.base_url + 'level',
                    type: 'post',
                    data: {
                        id: id
                    },
                    success: function(res) {
                        if (res.status == 1){
                            var level = res.level;
                            var count = 0;
                            var loop = [];
                            for(var i = 1; i <= 3; i++){
                                if(level['request'+i]){
                                    loop.push(i);
                                    count++;
                                }
                            }
                            level.count = count;
                            level.loop = loop;
                            level.half_score = Math.round((level.pass_score + level.full_score) / 2);
                            self.level = level.level;
                            self.levels.level = level;

                            self.level_cards();
                        } else if (res.info) {
                            show_msg(res.info);
                        }
                    },
                    error: function(res) {
                        self.show_msg('请求失败');
                    },
                    complete: function() {
                        $('#get_levels').button('reset');
                    }
                });
            },
            //关卡羁绊得分计算
            level_cards: function(){
                var self = this;
                var my_cards = [];
                for(var i = 0; i < self.list.length; i++){
                    var score = 0;
                    var card = self.list[i];
                    var prop = self.prop;

                    for(var j = 0; j < prop.length; j++){
                        score += card[prop[j]] * self.levels.level[prop[j]];
                    }

                    card.score = Math.round(score);
                    my_cards.push(card);
                }
                my_cards.sort(function(a,b){
                    return b.score - a.score;
                });

                self.levels.cards = my_cards;

                //高分羁绊
                self.levels.combine = my_cards.slice(0, 3);
            },
            //导出数据
            export_data: function(){
                var list = this.list;
                var data = [];

                if(this.batch.source == 'calculator'){
                    for(var i = 0; i < list.length; i++){
                        var arr = list[i].name.split('·');
                        data.push({
                            name: arr[1],
                            rarity: this.get_type_tag(list[i].type),
                            character: this.get_character_tag(list[i].category),
                            decision: list[i].decisiveness,
                            creativity: list[i].creativity,
                            appetency: list[i].kindness,
                            action: list[i].activity,
                            way: this.get_gain_tag(list[i].gain),
                            id: list[i].card_id
                        });
                    }
                    this.batch.export = JSON.stringify({
                        'user-defined': data,
                        'pre-defined': []
                    });
                } else if (this.batch.source == 'excel'){
                    for(var i = 0; i < list.length; i++){
                        var arr = list[i].name.split('·');
                        data.push([arr[1], list[i].decisiveness, list[i].creativity, list[i].kindness, list[i].activity].join("\t"));
                    }
                    this.batch.export = data.join("\n");
                }
            },
            //导入数据
            import_data: function(){
                var self = this;
                var data = self.batch.data;
                var list = [];
                if(self.batch.source == 'calculator'){
                    //测试数据：
                    //{"user-defined":[{"name":"新年大吉","rarity":"R","character":"周棋洛","decision":0,"creativity":0,"appetency":0,"action":0,"way":"自定义","id":1519353885350},{"name":"星空之吻","rarity":"SR","character":"白起","decision":55,"creativity":2554,"appetency":1132,"action":2830,"way":"自定义","id":1519353993354},{"name":"你的模样","rarity":"R","character":"周棋洛","decision":39,"creativity":1314,"appetency":1597,"action":1211,"way":"自定义","id":1519354093529}],"pre-defined":["交缠视线","记忆裂痕"]}
                    try{
                        data = JSON.parse(data);
                    } catch(e) {
                        self.show_msg('数据格式错误');
                        return false;
                    }

                    if(!self.empty(data['pre-defined'])){
                        for(var i = 0; i < data['pre-defined'].length; i++){
                            list.push({
                                name: data['pre-defined'][i],
                                decisiveness: 0,
                                creativity: 0,
                                kindness: 0,
                                activity: 0
                            });
                        }
                    }
                    if(!self.empty(data['user-defined'])){
                        for(var i = 0; i < data['user-defined'].length; i++){
                            list.push({
                                name: data['user-defined'][i].name,
                                decisiveness: data['user-defined'][i].decision,
                                creativity: data['user-defined'][i].creativity,
                                kindness: data['user-defined'][i].appetency,
                                activity: data['user-defined'][i].action
                            });
                        }
                    }
                } else if (self.batch.source == 'excel'){
                    //测试数据：
                    // 星空之吻    55  2554    1132    2830
                    // 点点萤光    905 30  1175    1052
                    // 心灵博弈    1618    1785    39  719
                    // 你的样子    39  1314    1597    1211
                    data = data.split("\n");
                    for(var i = 0; i < data.length; i++){
                        var arr = data[i].split("\t");
                        if(self.empty(arr) || arr.length < 5){
                            continue;
                        }
                        list.push({
                            name: arr[0],
                            decisiveness: arr[1],
                            creativity: arr[2],
                            kindness: arr[3],
                            activity: arr[4]
                        });
                    }
                }

                if(self.empty(list)){
                    self.show_msg('数据格式错误');
                    return false;
                }

                $('#import_data').button('loading');

                $.ajax({
                    url: self.base_url + 'import_data',
                    type: 'post',
                    data: {
                        token: self.get_token(),
                        list: JSON.stringify(list)
                    },
                    success: function(res) {
                        if (res.status == 1){
                            self.batch.data = '';
                            self.batch.fail = res.fail;
                            self.load();
                            $('#batch').modal('hide');
                        } else if (res.info) {
                            show_msg(res.info);
                        }
                    },
                    error: function(res) {
                        self.show_msg('请求失败');
                    },
                    complete: function() {
                        $('#import_data').button('reset');
                    }
                });
            },
            //批量导入
            show_batch: function(option){
                this.batch.option = option;
                this.batch.export = '';
                $('#batch').modal();
            },
            //筛选
            use_filter: function(filter, item){
                var ret = true;
                for(f in filter){
                    if(!this.empty(filter[f]) && (typeof(item[f]) == 'string' ? item[f].indexOf(filter[f]) < 0 : item[f] != filter[f])){
                        ret = false;
                        break;
                    }
                }
                return ret;
            },
            //保存羁绊
            save_card: function(){
                var self = this;
                $('#save_card').button('loading');

                var user_correct = 0;
                var data = self.predict_card(self.card_select.card_id, self.card_select.evolved, self.card_select.star, self.card_select.level);
                var prop = self.prop;
                for(var i = 0; i < prop.length; i++){
                    if(data[prop[i]] != self.card_select[prop[i]]){
                        user_correct = 1;
                    }
                }

                $.ajax({
                    url: self.base_url + 'save_card',
                    type: 'post',
                    data: {
                        token: self.get_token(),
                        card_id: self.card_select.card_id,
                        evolved: self.card_select.evolved,
                        star: self.card_select.star,
                        level: self.card_select.level,
                        decisiveness: self.card_select.decisiveness,
                        creativity: self.card_select.creativity,
                        kindness: self.card_select.kindness,
                        activity: self.card_select.activity,
                        user_correct: user_correct
                    },
                    success: function(res) {
                        if (res.status == 1){
                            var card = res.card;
                            var card_id = card.card_id;
                            if(card.predict){
                                self.cards[card_id].predict = card.predict;
                                delete card.predict;
                            }
                            if(card.correction){
                                self.cards[card_id].correction = card.correction;
                                delete card.correction;
                            }

                            var idx = self.my_cards.indexOf(card_id);
                            if(idx >= 0){
                                self.list[idx] = card;
                            } else {
                                self.list.push(card);
                            }
                            self.list.sort(function(a, b){
                                return b.total - a.total;
                            });

                            var my_cards = [];
                            for(var i = 0; i < self.list.length; i++){
                                my_cards.push(self.list[i].card_id);
                            }
                            self.my_cards = my_cards;

                            $('#card').modal('hide');
                        } else if (res.info) {
                            show_msg(res.info);
                        }
                    },
                    error: function(res) {
                        self.show_msg('请求失败');
                    },
                    complete: function() {
                        $('#save_card').button('reset');
                    }
                });
            },
            remove_all: function(){
                var ack = confirm('确定清空吗？');
                if(ack){
                    var self = this;
                    $.ajax({
                        url: self.base_url + 'remove_all',
                        type: 'post',
                        data: {
                            token: self.get_token()
                        },
                        success: function(res) {
                            if (res.status == 1){
                                self.my_cards = [];
                                self.list = [];
                            } else if (res.info) {
                                show_msg(res.info);
                            }
                        },
                        error: function(res) {
                            self.show_msg('请求失败');
                        }
                    });
                }
            },
            remove_card: function(id){
                var ack = confirm('确定删除吗？');
                if(ack){
                    var self = this;
                    $.ajax({
                        url: self.base_url + 'remove_card',
                        type: 'post',
                        data: {
                            token: self.get_token(),
                            card_id: id
                        },
                        success: function(res) {
                            if (res.status == 1){
                                var idx = self.my_cards.indexOf(id);
                                self.my_cards.splice(idx, 1);
                                self.list.splice(idx, 1);
                            } else if (res.info) {
                                show_msg(res.info);
                            }
                        },
                        error: function(res) {
                            self.show_msg('请求失败');
                        }
                    });
                }
            },
            //显示羁绊选择
            show_card: function(id){
                if(id){
                    this.card_select.card_id = id;
                }
                $('#card').modal();
            },
            //更新羁绊选择
            update_card_select: function(){
                var data = this.predict_card(this.card_select.card_id, this.card_select.evolved, this.card_select.star, this.card_select.level);
                var prop = this.prop;

                for(var i = 0; i < prop.length; i++){
                    this.card_select[prop[i]] = data[prop[i]];
                }
            },
            //羁绊数据预测
            predict_card: function(card_id, evolved, star, level){
                var card = this.cards[card_id];
                var key = evolved + ':' + star + ':' + level;
                if(card.correction[key]){
                    return card.correction[key];
                }

                var prop = this.prop
                var data = {};
                var weight = evolved == 0 ? 1 : 1.45;
                for(var i = 0; i < prop.length; i++){
                    data[prop[i]] = Math.round(weight * (level * (star * card.predict[prop[i]][0] + card.predict[prop[i]][1]) + card.predict[prop[i]][2]));
                }

                return data;
            },
            //更新公司数据
            update_company: function() {
                var self = this;
                $('#update_company').button('loading');

                $.ajax({
                    url: self.base_url + 'update_company',
                    type: 'post',
                    data: {
                        token: self.get_token(),
                        decisiveness: self.company.decisiveness,
                        creativity: self.company.creativity,
                        kindness: self.company.kindness,
                        activity: self.company.activity
                    },
                    success: function(res) {
                        if (res.info) {
                            show_msg(res.info);
                        }
                    },
                    error: function(res) {
                        self.show_msg('请求失败');
                    },
                    complete: function() {
                        $('#update_company').button('reset');
                    }
                });
            },
            //显示登录
            show_login: function(option) {
                this.login.option = option;
                $('#company').modal();
            },
            //登录
            user_login: function() {
                var self = this;
                $('#user_login').button('loading');

                if (self.login.name == '') {
                    self.login.warning = '请填写公司名称';
                    return false;
                }

                $.ajax({
                    url: self.base_url + self.login.option,
                    type: 'post',
                    data: {
                        name: self.login.name,
                        code: self.login.code
                    },
                    success: function(res) {
                        if (res.status == 1) {
                            //保存历史记录
                            var history = $.LS.get('history') || {};
                            if (typeof(history) == 'string') {
                                history = JSON.parse(history);
                            }
                            history[self.login.name] = self.login.code;
                            $.LS.set('history', JSON.stringify(history));
                            self.login.history = history;

                            //登录用户
                            self.user.name = self.login.name;
                            self.user.code = self.login.code;

                            //本地存储
                            $.LS.set('name', self.login.name);
                            $.LS.set('code', self.login.code);

                            self.login.name = '';
                            self.login.code = '';

                            self.load();

                            $('#company').modal('hide');
                        } else if (res.info) {
                            self.login.warning = res.info;
                        }
                    },
                    error: function(res) {
                        self.show_msg('请求失败');
                    },
                    complete: function() {
                        $('#user_login').button('reset');
                    }
                });
            },
            //注销
            logout: function() {
                //历史记录
                $.LS.set('history', JSON.stringify({}));
                this.login.history = {};

                //登录用户
                this.user.name = '';
                this.user.code = '';

                //本地存储
                $.LS.set('name', '');
                $.LS.set('code', '');

                this.company = {};
                this.list = [];
                this.my_cards = [];
            },
            //显示提示信息
            show_msg: function(msg) {
                alert(msg);
            },
            //获取标签
            get_gain_tag: function(gain){
                if(gain.indexOf('限定') >= 0){
                    return '限定';
                } else if (gain.indexOf('副本') >= 0) {
                    return '副本';
                } else if (gain.indexOf('充值') >= 0) {
                    return '充值';
                } else if (gain.indexOf('奖励') >= 0) {
                    return '奖励';
                } else if (gain.indexOf('许愿') >= 0) {
                    return '许愿';
                } else if (gain.indexOf('登录') >= 0) {
                    return '登录';
                } else {
                    return gain;
                }
            },
            //人物标签
            get_character_tag: function(category){
                category = parseInt(category, 10);
                var ret = '';
                switch(category){
                    case 1:
                        ret = '李泽言';
                        break;
                    case 2:
                        ret = '许墨';
                        break;
                    case 3:
                        ret = '周棋洛';
                        break;
                    case 4:
                        ret = '白起';
                        break;
                    case 5:
                        ret = '其他';
                        break;
                }
                return ret;
            },
            //星级标签
            get_rank_tag: function(item, score) {
                var rank = 0;
                if(score > item.full_score){
                    rank = 3;
                } else if (score > item.half_score) {
                    rank = 2;
                } else if (score > item.pass_score) {
                    rank = 1;
                }
                if(item.pass_score == 0){
                    rank = -1;
                }

                var ret = '';
                if (rank == -1) {
                    ret = '无数据';
                } else {
                    ret = rank + '星';
                }
                return ret;
            },
            //类别标签
            get_category_tag: function(category) {
                category = parseInt(category, 10);
                var ret = '';
                switch (category) {
                    case 1:
                        ret = '普通';
                        break;
                    case 2:
                        ret = '精英';
                        break;
                    case 3:
                        ret = '副本-许墨';
                        break;
                    case 4:
                        ret = '副本-白起';
                        break;
                    case 5:
                        ret = '副本-李泽言';
                        break;
                    case 6:
                        ret = '副本-周棋洛';
                        break;
                }
                return ret;
            },
            //星级
            get_star_print: function(star){
                var ret = '';
                for(var i = 0; i < star; i++){
                    ret += '☆';
                }
                return ret;
            },
            //进化标签
            get_evolved_tag: function(evolved){
                var ret = evolved == 1 ? '进化' : '未进化';
                return ret;
            },
            //类型标签
            get_type_tag: function(type){
                var ret = '';
                switch(type){
                    case 1:
                        ret = 'N';
                        break;
                    case 2:
                        ret = 'NH';
                        break;
                    case 3:
                        ret = 'R';
                        break;
                    case 4:
                        ret = 'SR';
                        break;
                    case 5:
                        ret = 'SSR';
                        break;
                }
                return ret;
            },
            //获取接口请求token
            get_token: function() {
                return btoa(encodeURIComponent(JSON.stringify(this.user)));
            },
            //判断数据或对象为空（增加判断0或''）
            empty: function(value) {
                return (Array.isArray(value) && value.length === 0) ||
                    (Object.prototype.isPrototypeOf(value) && Object.keys(value).length === 0) || !value;
            },
            load: function(){
                var self = this;

                $.ajax({
                    url: self.base_url + 'init',
                    type: 'post',
                    data: {
                        token: self.get_token()
                    },
                    success: function(res) {
                        if (res.status == 1) {
                            self.select = res.select;
                            self.cards = res.cards;

                            self.card_list = [];
                            for (id in self.cards) {
                                var card = self.cards[id];
                                self.card_list.push(card.name);
                            }

                            if (res.company) {
                                self.company = res.company;
                            }

                            if(res.list) {
                                self.list = res.list;
                                self.my_cards = [];

                                for(var i = 0; i < self.list.length; i++){
                                    self.my_cards.push(self.list[i].card_id);
                                }
                            }

                            if(!self.dom_init){
                                $('.typeahead').typeahead({
                                    source: self.card_list
                                });

                                $('.typeahead').click(function(){
                                    $(this).typeahead('lookup');
                                });

                                $('.typeahead').change(function(){
                                    var name = $(this).val();

                                    if(self.card_list.indexOf(name) >= 0){
                                        self.card_select.name = name;
                                        $(this).val('');
                                        self.show_card();
                                    }
                                });

                                $('#navbar-menu ul li a').click(function(){
                                    $('#navbar-menu').collapse('hide');
                                });

                                self.dom_init = true;
                            }
                        } else if (res.info) {
                            self.show_msg(res.info);
                        }
                    },
                    error: function(res) {
                        self.show_msg('请求失败');
                    }
                });

                var history = $.LS.get('history') || {};
                if (typeof(history) == 'string') {
                    self.login.history = JSON.parse(history);
                }
            }
        },
        mounted: function() {
            this.load();
        }
    });
    </script>
</body>

</html>